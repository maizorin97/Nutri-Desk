{% extends 'planner_base.html' %}

{% block title %} Nutridesk | Planes {% endblock %}

{% load static %}

{% block extra_links %}

<link href="{% static 'vendor/fontawesome-free/css/all.min.css' %}" rel="stylesheet" type="text/css">

{% endblock %}

{% block active-planes %} active-div {% endblock %}

{% block section1 %}


<body>
  <!-- ------- COMIENZO DE MODAL1 ------- -->
  <div id="modal1" class="modal fade" tabindex="-1" aria-labelledby="modal1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <!-- Page Heading -->
        <div class="modal-header">
          <h1 class="h3 mb-2 text-gray-800">Generación de Plan de Alimentación</h1>
        </div>
        <div class="modal-body">
          <p class="mb-4 text-justify">
            De acuerdo a tus características físicas actuales, se te recomendará un
            plan de alimentación acorde a tus necesidades. En la siguiente tabla, se
            describen los alimentos y su aporte calórico, según sea el enfoque que
            desees. Es importante que sigas estrictamente estas indicaciones para
            lograr realizar un avance en el proceso y auxiliarte con un profesional
            de la salud.
          </p>

          <div class="form-group row">
            <div class="col-sm-3 align-self-center">
              <label class="text-primary">Peso: {{infoUser.peso}} KG</label>
            </div>
            <div class="col-sm-3 align-self-center">
              <label class="text-primary">Altura: {{infoUser.altura}} CM</label>
            </div>
            <div class="col-sm-3 align-self-center">
              <label class="text-primary">Edad: {{edad|stringformat:".1f"}} Años</label>
            </div>
            <div class="col-sm-3 align-self-center">
              <label class="text-primary">Sexo: {% if infoUser.sexo == 'H'%} Hombre {% else %} Mujer {%endif%}</label>
            </div>
          </div>
          <div class="form-group row">
            <div class="col-sm-4 align-self-center">
              <label for="txtObjetivo" class="text-primary">¿Cuál es su Objetivo?</label>
              <select class="form-control" id="txtObjetivo">
                <option>Mantener Peso</option>
                <option>Subir Peso</option>
                <option>Bajar Peso</option>
              </select>
            </div>
            <div class="col-sm-4 align-self-center">
              <label for="txtActividadFisica" class="text-primary">¿Realiza actividad física?</label>
              <select class="form-control" id="txtActividadFisica">
                <option>No hace nada de ejercicio</option>
                <option>Ejercicio ligero dos días por semana</option>
                <option>Ejercicio moderado, unos cuatro días por semana</option>
                <option>Deporte regular seis días a la semana</option>
                <option>Deportista de élite o entrena muy intenso cada día</option>
              </select>
            </div>

          </div>

          <form method="POST">
            {% csrf_token %}

            <div class="form-group row my-2">
              <div class="col-sm-4 align-self-center">
                <label for="txtNombrePlan" class="text-primary">Nombre del Plan</label>
                <input type="text" class="form-control form-control-user" name="txtNombrePlan" id="txtNombrePlan"
                  placeholder="Ingrese un nombre" required />
              </div>

              <div class="col-sm-4 align-self-center">
                <label for="txtAporteCalorico" class="text-primary">Aporte Calórico</label>
                <input type="text" class="form-control form-control-user" name="txtAporteCalorico"
                  id="txtAporteCalorico" placeholder="Kcal" required readonly />
              </div>
            </div>

            <div class="form-group row my-2">
              <div class="col-sm-4 align-self-center">
                <label class="text-primary">IMC:</label>
                <label id="txtIMC" class="text-primary">_</label>
                <label id="txtMsjIMC">_</label>
              </div>

              <div class="col-sm-4 align-self-center">
                <label class="text-primary">TMB:</label>
                <label id="txtTMB" class="text-primary">_</label> Kcal
              </div>
            </div>

            <div class="row my-2">
              <div class="col-sm-12 align-self-center center-align" id="div-cargadorBoton">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p>Cargando alimentos...</p>
  
              </div>
            </div>

            <div class="d-flex flex-row justify-content-between flex-wrap">
              <div><span class="badge bg-cereales text-dark">Cereales y Tubérculos</span></div>
              <div><span class="badge bg-verduras text-dark">Verduras</span></div>
              <div> <span class="badge bg-frutas text-dark">Frutas</span></div>
              <div> <span class="badge bg-animal text-dark">Origen Animal</span></div>
              <div><span class="badge bg-leche text-dark">Leche</span></div>
              <div><span class="badge bg-leguminosas text-dark">Leguminosas</span></div>
              <div><span class="badge bg-grasas text-dark">Grasas</span></div>
              <div><span class="badge bg-azucares text-dark">Azucares</span></div>
              <div><span class="badge bg-libre text-dark">Libres en Energía</span></div>
            </div>

            <!-- ------- NEW MENU TEST ------- -->
            <div class="card my-4">
              <div class="card-header py-2">
                <h6>Nuevo Plan</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="d-flex flex-column col col-lg-4 col-md-6 col-sm-12 col-12 mb-2">
                    <div>
                      <i class="fas fa-sun inline-icon" aria-hidden="true"></i>
                      <h6 class="inline-icon">Desayuno</h6>
                    </div>
                    <hr>
                    <div class="d-flex flex-column select-column mb-2">
                    </div>
                  </div>
                  <div class="d-flex flex-column col col-lg-4 col-md-6 col-sm-12 col-12 mb-2">
                    <div>
                      <i class="fas fa-utensils inline-icon" aria-hidden="true"></i>
                      <h6 class="inline-icon">Colación 1</h6>
                    </div>
                    <hr>
                    <div class="d-flex flex-column select-column mb-2">
                    </div>
                  </div>
                  <div class="d-flex flex-column col col-lg-4 col-md-6 col-sm-12 col-12 mb-2">
                    <div>
                      <i class="far fa-sun inline-icon" aria-hidden="true"></i>
                      <h6 class="inline-icon">Comida</h6>
                    </div>
                    <hr>
                    <div class="d-flex flex-column select-column mb-2">
                    </div>
                  </div>
                  <div class="d-flex flex-column col col-lg-4 col-md-6 col-sm-12 col-12 mb-2">
                    <div>
                      <i class="fas fa-utensils inline-icon" aria-hidden="true"></i>
                      <h6 class="inline-icon">Colación 2</h6>
                    </div>
                    <hr>
                    <div class="d-flex flex-column select-column mb-2">
                    </div>
                  </div>
                  <div class="d-flex flex-column col col-lg-4 col-md-6 col-sm-12 col-12 mb-2">
                    <div>
                      <i class="fas fa-moon inline-icon" aria-hidden="true"></i>
                      <h6 class="inline-icon">Cena</h6>
                    </div>
                    <hr>
                    <div class="d-flex flex-column select-column mb-2">
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-footer">
                <button type="submit" name="btnGuardarPlan" class="align-middle btn btn-primary">
                  Guardar Nuevo Plan
                </button>
              </div>
            </div>
            <!-- ------- NEW MENU TEST ------- -->
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- ------- FIN DE MODAL 1 ------- -->

  <!-- ------- INICIO MODAL VER HADAD ------- -->

  <div class="modal fade" id="modalVer" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-body tablasAlimentoContainer">
          <!-- ------- TABS ------- -->
          <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="desayuno-tab" data-bs-toggle="tab" data-bs-target="#desayuno" type="button"
                role="tab" aria-controls="desayuno" aria-selected="true">Desayuno</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="colacion1-tab" data-bs-toggle="tab" data-bs-target="#colacion1" type="button"
                role="tab" aria-controls="colacion1" aria-selected="false">Colación 1</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="comida-tab" data-bs-toggle="tab" data-bs-target="#comida" type="button"
                role="tab" aria-controls="comida" aria-selected="false">Comida</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="colacion2-tab" data-bs-toggle="tab" data-bs-target="#colacion2" type="button"
                role="tab" aria-controls="colacion2" aria-selected="false">Colación 2</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="cena-tab" data-bs-toggle="tab" data-bs-target="#cena" type="button"
                role="tab" aria-controls="cena" aria-selected="false">Cena</button>
            </li>
          </ul>
          <!-- ------- TABS ------- -->

          <!-- ======= TAB CONTENT ======= -->
          <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active container" id="desayuno" role="tabpanel" aria-labelledby="desayuno-tab">
              <table class="table table-hover table-striped table-borderless my-2">
                <thead class="bg-primary">
                  <th scope="col">Alimento</th>
                  <th scope="col">Tipo de Alimento</th>
                  <th scope="col">Porción</th>
                </thead>
                <tbody id="desayuno-table"></tbody>
              </table>
            </div>
            <div class="tab-pane fade container" id="colacion1" role="tabpanel" aria-labelledby="colacion1-tab">
              <table class="table table-hover table-striped table-borderless my-2">
                <thead class="bg-primary">
                  <th scope="col">Alimento</th>
                  <th scope="col">Tipo de Alimento</th>
                  <th scope="col">Porción</th>
                </thead>
                <tbody id="colacion1-table"></tbody>
              </table>
            </div>
            <div class="tab-pane fade container" id="comida" role="tabpanel" aria-labelledby="comida-tab">
              <table class="table table-hover table-striped table-borderless my-2">
                <thead class="bg-primary">
                  <th scope="col">Alimento</th>
                  <th scope="col">Tipo de Alimento</th>
                  <th scope="col">Porción</th>
                </thead>
                <tbody id="comida-table"></tbody>
              </table>
            </div>
            <div class="tab-pane fade container" id="colacion2" role="tabpanel" aria-labelledby="colacion2-tab">
              <table class="table table-hover table-striped table-borderless my-2">
                <thead class="bg-primary">
                  <th scope="col">Alimento</th>
                  <th scope="col">Tipo de Alimento</th>
                  <th scope="col">Porción</th>
                </thead>
                <tbody id="colacion2-table"></tbody>
              </table>
            </div>
            <div class="tab-pane fade container" id="cena" role="tabpanel" aria-labelledby="cena-tab">
              <table class="table table-hover table-striped table-borderless my-2">
                <thead class="bg-primary">
                  <th scope="col">Alimento</th>
                  <th scope="col">Tipo de Alimento</th>
                  <th scope="col">Porción</th>
                </thead>
                <tbody id="cena-table"></tbody>
              </table>
            </div>
          </div>
          <!-- ======= END TAB CONTENT ======= -->
        </div>
        <form method="POST">
        {% csrf_token %}
          <input type="hidden" name="idPlan" id="idPlanModal">
          <div class="modal-footer d-flex justify-content-center">
            <p>Recordar:</p>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="lunes" id="lunes" value="lunes">
              <label class="form-check-label" for="lunes">Lunes</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="martes" id="martes" value="martes">
              <label class="form-check-label" for="martes">Martes</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="miercoles" id="miercoles" value="miercoles">
              <label class="form-check-label" for="miercoles">Miércoles</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="jueves" id="jueves" value="jueves">
              <label class="form-check-label" for="jueves">Jueves</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="viernes" id="viernes" value="viernes">
              <label class="form-check-label" for="viernes">Viernes</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="sabado" id="sabado" value="sabado">
              <label class="form-check-label" for="sabado">Sábado</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" name="domingo" id="domingo" value="domingo">
              <label class="form-check-label" for="domingo">Domingo</label>
            </div>
            <button class="btn btn-small btn-primary" name="btnGuardarCalendario" type="submit">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>



  <!-- ------- FIN MODAL VER------- -->



  <!-- ------- INICIO DE TABLA DE PLANES ------- -->
  <div class="container">
    <div class="row justify-content-between">
      <div class="col-lg-6">
        <h1>Planes de Alimentación</h1>
      </div>
      <div class="col-lg-2 justify-content-end">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal1">
          Nuevo plan
        </button>
      </div>
    </div>
    <div class="card my-2">
      <div class="row">
        <div class="col s12 center">
          <table class="table table-hover table-striped table-borderless" id="mitabla">
            <thead class="bg-primary rounded-2">
              <tr>
                <th class="headNombre" scope="col">Nombre</th>
                <th class="headAporte" scope="col">Aporte calórico (Kcals)</th>
                <th class="headAccion" scope="col">Acción</th>
              </tr>
            </thead>
            <tbody id="cargadorU">
              {% for plan in lista_planes %}
              {% if plan.idUsuario.username == user.username%}
              <tr name="plan">
                <th scope="row" style="display: none;">{{ plan.idPlan }}</th>
                <td>{{ plan.descripcion }}</td>
                <td class="aporte">{{ plan.calorias }}</td>
                <td class="accion">
                  <i class="fas fa-trash-alt deleteButton mx-2"></i>
                  <i class="fas fa-eye seeButton mx-2"></i>
                  <div class="spinner-border spinner-border-sm text-primary mx-2" role="status" style="display: none;">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </td>
              </tr>
              {% endif %}
              {% endfor %}
          </table>
        </div>
      </div>
    </div>
    <div class="d-flex flex-row justify-content-end">
      <button type="button" class="btn btn-primary btn-sm nav-button d-flex justify-content-center align-items-center"
        id="leftArrow">
        <i class="fas fa-backward" aria-hidden="true"></i>
      </button>
      <div class="noPage">
        <i class="texto" id="noPage"> 1 </i>
      </div>
      <button type="button" class="btn btn-primary nav-button d-flex justify-content-center align-items-center"
        id="rightArrow">
        <i class="fas fa-forward" aria-hidden="true"></i>
      </button>
    </div>
  </div>
  <!-- ------- FIN DE TABLA DE PLANES ------- -->
</body>
<!-- /.container-fluid -->

{% endblock %}

{% block extra-scripts %}
<script>
  var dic_al;
  var dict_alimentos;
  var dict_alimentos2;
  function calcular_requisitos(e) {
    e.preventDefault();
    var peso = {{ infoUser.peso }};
    var altura = {{ infoUser.altura }};
    var sexo = '{{infoUser.sexo}}';
    var edad = {{ edad }};
    var imc = (peso / Math.pow(altura/100, 2));
    var objetivo = document.getElementById("txtObjetivo").selectedIndex;
    var actividad = document.getElementById("txtActividadFisica").selectedIndex;

    var txt_imc = document.getElementById("txtIMC");
    var txt_msj_imc = document.getElementById("txtMsjIMC");
    var txt_tmb = document.getElementById("txtTMB");

    txt_imc.innerHTML = imc.toPrecision(4);
    txt_msj_imc.innerHTML = indice_masa_corporal(imc);
    var tmb = tasa_metabolica_basal(sexo, edad, peso, altura, objetivo, actividad);
    txt_tmb.innerHTML = tmb;
    switch(e.target.id){
      case 'cargadorBotonAG':
        mostrar_plan_ag(tmb);
      break;
      case 'cargadorBotonTablas':
        mostrar_plan_tablas(tmb);
      break;
      case 'cargadorBotonTablasAG':
        mostrar_plan_tablas_algo(tmb);
      break;
    }
    
  }

  function indice_masa_corporal(imc) {
    //fuente
    //https://www.seedo.es/index.php/pacientes/calculo-imc
    if (imc < 18.5) {
      return "Peso insuficiente";
    } else if (imc < 25) {
      return "Peso normal";
    } else if (imc < 27) {
      return "Sobrepeso grado I";
    } else if (imc < 30) {
      return "Sobrepeso grado II (preobesidad)";
    } else if (imc < 35) {
      return "Obesidad de tipo I";
    } else if (imc < 40) {
      return "Obesidad de tipo II";
    } else if (imc < 50) {
      return "Obesidad de tipo III (mórbida)";
    } else if (imc >= 50) {
      return "Obesidad de tipo IV (extrema)";
    }
  }

  function tasa_metabolica_basal(sexo, edad, peso, altura, meta, actividad_fisica) {
    //fuente
    //https://www.axahealthkeeper.com/blog/calculo-de-calorias-diarias-cuantas-calorias-debo-consumir-al-dia/
    //https://www.axahealthkeeper.com/blog/que-es-y-como-calcular-la-tasa-metabolica-basal/
    var tmb = 0;
    switch (sexo) {
      case 'H'://si es hombre
        tmb = (10 * peso) + (6.5 * altura) - (5 * edad) - 161;
        break;
      case 'M':// si es mujer
        tmb = (10 * peso) + (6.5 * altura) - (5 * edad) + 5;
        break;
      default:
        tmb = -1;
    }
    switch (actividad_fisica) {
      case 0://nada de ejercicio
        tmb *= 1.2;
        break;
      case 1://ejercicio ligero dos días por semana
        tmb *= 1.375;
        break;
      case 2://ejercicio moderado, unos cuatro días por semana
        tmb *= 1.55;
        break;
      case 3://deporte regular seis días a la semana
        tmb *= 1.725;
        break;
      default://deportista de élite
        tmb *= 1.9;
    }

    switch (meta) {
      case 0:
        tmb *= 1;
        break;
      case 1:
        tmb *= 0.75; // 15%-20%
        break;
      default:
        tmb *= 1.15;
    }
    return tmb.toPrecision(4);
  }

  function mostrar_plan_ag(tmb) {
    var plan = get_plan_ag(tmb);
    var tabla_plan = document.getElementsByClassName("select-column");
    tabla_plan[0].innerHTML = construir_colacion_ag(0, plan[0], dict_alimentos); //desayuno
    tabla_plan[1].innerHTML = construir_colacion_ag(1, plan[1], dict_alimentos); //colacion1
    tabla_plan[2].innerHTML = construir_colacion_ag(2, plan[2], dict_alimentos); //comida
    tabla_plan[3].innerHTML = construir_colacion_ag(3, plan[3], dict_alimentos); //colacon2
    tabla_plan[4].innerHTML = construir_colacion_ag(4, plan[4], dict_alimentos); //cena
    agregar_listeners();
  }



  function get_plan_ag(kcal) {
          let alimentos=[]
          alimentos[0]=algoritmo_genetico(kcal*0.2666)
          alimentos[1]=algoritmo_genetico(kcal*0.1)
          alimentos[2]=algoritmo_genetico(kcal*0.2666)
          alimentos[3]=algoritmo_genetico(kcal*0.1)
          alimentos[4]=algoritmo_genetico(kcal*0.2666)
         return alimentos
      }

  
  function construir_colacion_ag(tc, plan, dic) {
    var llave_comida = ["Desayuno", "Colacion1", "Comida", "Colacion2", "Cena"]
    var llave_alimentos = ["Cereales y tubérculos", "Verduras", "Frutas", "Alimentos de origen animal",
      "Leche", "Leguminosas", "Grasas", "Azúcares", "Alimentos libres en energía"];
    var colors={
      3: "bg-cereales", 
      4: "bg-cereales",
      1: "bg-verduras", 
      2: "bg-frutas", 
      6: "bg-animal",
      7: "bg-animal",
      8: "bg-animal",
      9: "bg-animal",
      10: "bg-leche", 
      11: "bg-leche", 
      12: "bg-leche", 
      13: "bg-leche", 
      5: "bg-leguminosas", 
      20: "bg-grasas", 
      21: "bg-grasas", 
      22: "bg-grasas", 
      16: "bg-azucares", 
      17: "bg-azucares", 
      14: "bg-libre",
      15: "bg-libre",
      18: "bg-libre",
      19: "bg-libre"
    };
    console.log(plan)
    var html_code = "<div>";
    for (var i = 0; i < plan.length; i++) {//[]
      for (var j = 0; j < plan[i]; j++) {//n
        html_code += "<div><select class='form-select "+ colors[dic[i][1]] + " border-light rounded-3' name='" + llave_comida[tc] + "'>"
        // Las primeras 2 posiciones del arreglo dic[i] son la energia y el id del grupo respectivamente
        for (var k = 0; k < dic[i].length-2; k++) {
          html_code += "<option class='bg-light' value = '" + dic[i][k+2][1] + "'>" + dic[i][k+2][0] + "</option>"
        }
        html_code += "</select></div>";
      }
    }
    html_code += "</div>";
    return html_code;
  }

  function mostrar_plan_tablas(tmb) {
    var plan = get_plan_tablas(tmb);
    var tabla_plan = document.getElementsByClassName("select-column");
    tabla_plan[0].innerHTML = construir_colacion_tablas(0, plan[0], dict_alimentos2); //desayuno
    tabla_plan[1].innerHTML = construir_colacion_tablas(1, plan[1], dict_alimentos2); //colacion1
    tabla_plan[2].innerHTML = construir_colacion_tablas(2, plan[2], dict_alimentos2); //comida
    tabla_plan[3].innerHTML = construir_colacion_tablas(3, plan[3], dict_alimentos2); //colacon2
    tabla_plan[4].innerHTML = construir_colacion_tablas(4, plan[4], dict_alimentos2); //cena
    agregar_listeners();
  }
  function mostrar_plan_tablas_algo(tmb){
    var plan = get_plan_tablas_algo(tmb);
    var tabla_plan = document.getElementsByClassName("select-column");
    tabla_plan[0].innerHTML = construir_colacion_ag(0, plan[0], dict_alimentos); //desayuno
    tabla_plan[1].innerHTML = construir_colacion_ag(1, plan[1], dict_alimentos); //colacion1
    tabla_plan[2].innerHTML = construir_colacion_ag(2, plan[2], dict_alimentos); //comida
    tabla_plan[3].innerHTML = construir_colacion_ag(3, plan[3], dict_alimentos); //colacon2
    tabla_plan[4].innerHTML = construir_colacion_ag(4, plan[4], dict_alimentos); //cena
    agregar_listeners();
  }
  function get_plan_tablas_algo(kcal){
      /* [[desayuno],[colacion1],[comida],[colacion2],[cena]]
    [CEREALES Y TUBÉRCULOS,VERDURAS,FRUTAS,ALIMENTOS DE ORIGEN ANIMAL,LECHE Y SUSTITUTOS,
    LEGUMINOSAS,GRASAS,AZÚCARES,ALIMENTOS LIBRES DE ENERGÍA]*/
    if (kcal < 1000) {
      return algoritmo_genetico_tablas([[1, 1, 1, 1, 1, 0, 1, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0], [2, 2, 1, 1, 1, 0, 1, 0, 0], [0, 0, 0, 0, 1, 0, 0, 0, 0], [1, 1, 1, 0, 0, 0, 0, 0, 1]],kcal);
    } else if (kcal < 1200) {
      return algoritmo_genetico_tablas([[2, 1, 1, 0, 0, 0, 1, 0, 1], [1, 0, 0, 0, 1, 0, 0, 0, 0], [2, 2, 1, 2, 1, 0, 1, 0, 0], [0, 1, 0, 0, 1, 0, 0, 0, 0], [1, 1, 0, 0, 1, 0, 0, 0, 0]],kcal);
    } else if (kcal < 1400) {
      return algoritmo_genetico_tablas([[2, 1, 1, 1, 1, 0, 1, 0, 0], [0, 0, 1, 0, 1, 0, 0, 0, 0], [2, 2, 0, 2, 0, 0, 1, 0, 0], [1, 0, 0, 0, 1, 0, 0, 0, 0], [1, 1, 1, 1, 1, 0, 0, 0, 0]],kcal);
    } else if (kcal < 1600) {
      return algoritmo_genetico_tablas([[2, 2, 1, 0, 1, 0, 1, 0, 0], [0, 1, 0, 1, 0, 0, 0, 0, 0], [2, 2, 1, 2, 1, 0, 1, 0, 0], [1, 0, 1, 0, 0, 0, 0, 0, 0], [1, 2, 1, 1, 0, 0, 0, 0, 1]],kcal);
    } else if (kcal < 1800) {
      return algoritmo_genetico_tablas([[3, 1, 2, 1, 1, 0, 1, 0, 0], [1, 1, 0, 0, 0, 0, 0, 0, 0], [2, 2, 1, 2, 1, 0, 1, 0, 0], [1, 0, 0, 0, 1, 0, 0, 0, 0], [1, 2, 1, 1, 0, 0, 0, 0, 1]],kcal);
    } else  {
      return algoritmo_genetico_tablas([[3, 1, 2, 2, 1, 0, 1, 0, 0], [1, 1, 0, 0, 0, 0, 0, 0, 0], [2, 2, 1, 2, 1, 0, 1, 0, 1], [1, 0, 1, 0, 0, 0, 0, 0, 0], [1, 2, 1, 1, 1, 0, 0, 0, 0]],kcal);
    }
  }

  function get_plan_tablas(kcal) {
    /* [[desayuno],[colacion1],[comida],[colacion2],[cena]]
    [CEREALES Y TUBÉRCULOS,VERDURAS,FRUTAS,ALIMENTOS DE ORIGEN ANIMAL,LECHE Y SUSTITUTOS,
    LEGUMINOSAS,GRASAS,AZÚCARES,ALIMENTOS LIBRES DE ENERGÍA]*/
    if (kcal < 1000) {
      return [[1, 1, 1, 1, 1, 0, 1, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0], [2, 2, 1, 1, 1, 0, 1, 0, 0], [0, 0, 0, 0, 1, 0, 0, 0, 0], [1, 1, 1, 0, 0, 0, 0, 0, 1]];
    } else if (kcal < 1200) {
      return [[2, 1, 1, 0, 0, 0, 1, 0, 1], [1, 0, 0, 0, 1, 0, 0, 0, 0], [2, 2, 1, 2, 1, 0, 1, 0, 0], [0, 1, 0, 0, 1, 0, 0, 0, 0], [1, 1, 0, 0, 1, 0, 0, 0, 0]];
    } else if (kcal < 1400) {
      return [[2, 1, 1, 1, 1, 0, 1, 0, 0], [0, 0, 1, 0, 1, 0, 0, 0, 0], [2, 2, 0, 2, 0, 0, 1, 0, 0], [1, 0, 0, 0, 1, 0, 0, 0, 0], [1, 1, 1, 1, 1, 0, 0, 0, 0]];
    } else if (kcal < 1600) {
      return [[2, 2, 1, 0, 1, 0, 1, 0, 0], [0, 1, 0, 1, 0, 0, 0, 0, 0], [2, 2, 1, 2, 1, 0, 1, 0, 0], [1, 0, 1, 0, 0, 0, 0, 0, 0], [1, 2, 1, 1, 0, 0, 0, 0, 1]];
    } else if (kcal < 1800) {
      return [[3, 1, 2, 1, 1, 0, 1, 0, 0], [1, 1, 0, 0, 0, 0, 0, 0, 0], [2, 2, 1, 2, 1, 0, 1, 0, 0], [1, 0, 0, 0, 1, 0, 0, 0, 0], [1, 2, 1, 1, 0, 0, 0, 0, 1]];
    } else {
      return [[3, 1, 2, 2, 1, 0, 1, 0, 0], [1, 1, 0, 0, 0, 0, 0, 0, 0], [2, 2, 1, 2, 1, 0, 1, 0, 1], [1, 0, 1, 0, 0, 0, 0, 0, 0], [1, 2, 1, 1, 1, 0, 0, 0, 0]];
    }
  }

  function construir_colacion_tablas(tc, plan, dic) {
    var llave_comida = ["Desayuno", "Colacion1", "Comida", "Colacion2", "Cena"]
    var llave_alimentos = ["Cereales y tubérculos", "Verduras", "Frutas", "Alimentos de origen animal",
      "Leche", "Leguminosas", "Grasas", "Azúcares", "Alimentos libres en energía"];
    var colors={
      "Cereales y tubérculos": "bg-cereales", 
      "Verduras": "bg-verduras", 
      "Frutas": "bg-frutas", 
      "Alimentos de origen animal": "bg-animal",
      "Leche": "bg-leche", 
      "Leguminosas": "bg-leguminosas", 
      "Grasas": "bg-grasas", 
      "Azúcares": "bg-azucares", 
      "Alimentos libres en energía": "bg-libre"
    };
    var html_code = "<div>";
    for (var i = 0; i < plan.length; i++) {//[]
      for (var j = 0; j < plan[i]; j++) {//n
        html_code += "<div><select class='form-select "+ colors[llave_alimentos[i]] + " border-light rounded-3' name='" + llave_comida[tc] + "'>"
        for (var k = 0; k < dic[llave_alimentos[i]].length; k++) {
          html_code += "<option class='bg-light' value = '" + dic[llave_alimentos[i]][k][1] + "'>" + dic[llave_alimentos[i]][k][0] + "</option>"
        }
        html_code += "</select></div>";
      }
    }
    html_code += "</div>";
    return html_code;
  }

  function agregar_listeners() {
    var llave_comida = ["Desayuno", "Colacion1", "Comida", "Colacion2", "Cena"];
    var selects = {};
    for (var i = 0; i < llave_comida.length; i++) {
      selects[llave_comida[i]] = document.getElementsByName(llave_comida[i]);
      for (var j = 0; j < selects[llave_comida[i]].length; j++) {
        var casilla = selects[llave_comida[i]][j]
        casilla.addEventListener("change",
          function () {
            recalcular(selects);
          }, false
        );
      }
    }
    recalcular(selects);
  }

  function recalcular(selects) {
    var suma = 0;
    var llave_comida = ["Desayuno", "Colacion1", "Comida", "Colacion2", "Cena"];
    for (var i = 0; i < llave_comida.length; i++) {
      for (var j = 0; j < selects[llave_comida[i]].length; j++) {
        var casilla = selects[llave_comida[i]][j]
        suma += dic_al[casilla.value][0];
      }
    }
    var txt_aporte_calorico = document.getElementById("txtAporteCalorico");
    txt_aporte_calorico.value = suma;
  }
  document.addEventListener('DOMContentLoaded', function () {

    //Event listener de botones de eliminar
    Array.from(document.getElementsByClassName("deleteButton")).forEach(
      button => {
        button.addEventListener("click", () => {
          Swal.fire({
            title: '¿Esta seguro?',
            text: "No sera posible revertir esta accion",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '¡Si, eliminarlo!',
            cancelButtonText: 'Cancelar'
          }).then((result) => {
            let idPlan = button.parentElement.parentElement.children[0].innerText;
            let csrftoken = '{{ csrf_token }}';
            if (result.isConfirmed) {
              $.ajax({
                url: '/planes',
                type: 'DELETE',
                data: idPlan,
                headers: { 'X-CSRFToken': csrftoken },
                success: function (result) {
                  Swal.fire(
                    '¡Eliminado!',
                    'Tu plan ha sido eliminado',
                    'success'
                  ).then((result) => {
                    location.reload();
                  }
                  );
                },
                error: function (result) {
                  Swal.fire(
                    '¡Oops..Ocurrio un error!',
                    'Intentelo mas tarde',
                    'error'
                  )
                }
              });

            }
          });
        });
      });
    //Event listener de botones para ver
    Array.from(document.getElementsByClassName("seeButton")).forEach(
      button => {
        button.addEventListener("click", () => {
          //$('#modalVer').modal('show')
          button.parentElement.children[1].style.display = "none"
          button.parentElement.children[2].style.display = "inline-block"
          let idPlan = button.parentElement.parentElement.children[0].innerText;
          let csrftoken = '{{ csrf_token }}';
          $.ajax({
            url: '/planes',
            type: 'GET',
            data: { "plan_id": idPlan },
            headers: { 'X-CSRFToken': csrftoken },
            dataType: "json",
            error: function (result) {
              Swal.fire(
                '¡Oops..Ocurrio un error!',
                'Intentelo mas tarde',
                'error'
              )
            },
            success: function (result) {
              document.getElementById("idPlanModal").value=idPlan
              let tablaDesayuno = document.getElementById("desayuno-table");
              let tablaColacion1 = document.getElementById("colacion1-table");
              let tablaComida = document.getElementById("comida-table");
              let tablaColacion2 = document.getElementById("colacion2-table");
              let tablaCena = document.getElementById("cena-table");
              tablaDesayuno.innerHTML = "";
              tablaColacion1.innerHTML = "";
              tablaComida.innerHTML = "";
              tablaColacion2.innerHTML = "";
              tablaCena.innerHTML = "";
              result.forEach(colacion => {
                let tabla;
                if (colacion.tipoComida == "Desayuno")
                  tabla = tablaDesayuno
                if (colacion.tipoComida == "Colación 1")
                  tabla = tablaColacion1
                if (colacion.tipoComida == "Comida")
                  tabla = tablaComida
                if (colacion.tipoComida == "Colación 2")
                  tabla = tablaColacion2
                if (colacion.tipoComida == "Cena")
                  tabla = tablaCena
                tabla.innerHTML += getAlimentoRow(colacion);
              });
              $('#modalVer').modal('show')
              button.parentElement.children[2].style.display = "none"
              button.parentElement.children[1].style.display = "inline"
            }
          });
        });
      });
    //Ocultar planes no necesarios
    var planes = Array.from(document.getElementsByName("plan"));
    for (var i = 5; i < planes.length; i++) {
      planes[i].style.display = "none";
    }
    //Event listener de flechas de navegacion
    var page = 0;
    document.getElementById("leftArrow").addEventListener("click", () => {
      if (page != 0) {
        for (var i = 5 * page; i < planes.length && i < (5 * (page + 1)); i++) {
          planes[i].style.display = "none";
        }
        page -= 1;
        for (var i = 5 * page; i < planes.length && i < (5 * (page + 1)); i++) {
          planes[i].style.display = "table-row";
        }
        document.getElementById("noPage").innerText = page + 1;
      }
    });
    document.getElementById("rightArrow").addEventListener("click", () => {
      if (planes.length > 5 * (page + 1)) {
        for (var i = 5 * page; i < planes.length && i < (5 * (page + 1)); i++) {
          planes[i].style.display = "none";
        }
        page += 1;
        for (var i = 5 * page; i < planes.length && i < (5 * (page + 1)); i++) {
          planes[i].style.display = "table-row";
        }
        document.getElementById("noPage").innerText = page + 1;
      }
      else {
        Swal.fire({
          title: 'Oops...',
          text: "Parece que ya no hay mas planes",
          icon: 'info',
        });
      }
    });
    //Cargador de lista de alimentos
    $.ajax({
      url: 'getDatos',
      type: 'GET',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
      dataType: "json",
      success: function(result) {
              console.log("Se recibieorn los alimentos");
              dict_alimentos2={};
              dic_al={};
              dict_alimentos=[];
              let dict_alimentos_aux={}
              result.listaAlimentos.forEach((alimento)=>{
                dic_al[alimento.idAlimento]=[alimento.energia,alimento.proteina];
              });
              result.listaGrupos.forEach((grupo) => {
          dict_alimentos2[grupo.nombre] = []
        });
        result.listaAlimentos.forEach((alimento) => {
          dict_alimentos2[alimento.nombreGrupo].push([alimento.nombre, alimento.idAlimento]);
        });
              result.listaGrupos.forEach((grupo)=>{
                dict_alimentos_aux[grupo.idGrupo]=[grupo.energia,grupo.idGrupo]
              });
              result.listaAlimentos.forEach((alimento)=>{
                dict_alimentos_aux[alimento.idGrupo].push([alimento.nombre,alimento.idAlimento]);
              });
              for(let [key,value] of Object.entries(dict_alimentos_aux)){
                if(value.length > 2){
                  dict_alimentos.push(value)
                }
              }
             
              document.getElementById("div-cargadorBoton").innerHTML = `
              <button id="cargadorBotonAG" class="align-middle btn btn-primary"
              onclick="calcular_requisitos(event)">
                Generar Plan AG
              </button>
              <button id="cargadorBotonTablas" class="align-middle btn btn-primary"
              onclick="calcular_requisitos(event)">
                Generar Plan Tablas
              </button>
              <button id="cargadorBotonTablasAG" class="align-middle btn btn-primary"
              onclick="calcular_requisitos(event)">
                Generar Plan Tablas y AG
              </button>
        `
            }
    });
  });
  function getAlimentoRow(json) {
    innerHTML = `
    <tr>
      <td>${json.nombre}</td>
      <td>${json.grupo}</td>
      <td>${json.racion}</td>
    </tr>
    `;
    return innerHTML;
  }
  /*
     * Funciones de bisect // https://stackoverflow.com/questions/43359623/javascripts-equivalent-of-rs-findinterval-or-pythons-bisect-bisect-left
    */
    function bisect(sortedList, el){
  
  if(!sortedList.length) return 0;

  if(sortedList.length == 1) {
    return el > sortedList[0] ? 1 : 0;
  }

  let lbound = 0;
  let rbound = sortedList.length - 1;
  return bisect(lbound, rbound);

// note that this function depends on closure over lbound and rbound
// to work correctly
  function bisect(lb, rb){
    if(rb - lb == 1){
      if(sortedList[lb] < el && sortedList[rb] >= el){
        return lb + 1;
      }

      if(sortedList[lb] == el){
        return lb;
      }
    }

    if(sortedList[lb] > el){
      return 0;
    }

    if(sortedList[rb] < el){
      return sortedList.length
    }

    let midPoint = lb + (Math.floor((rb - lb) / 2));
    let midValue = sortedList[midPoint];

    if(el <= midValue){
      rbound = midPoint
    }

    else if(el > midValue){
      lbound = midPoint
    }

    return bisect(lbound, rbound);
  }
}
    /*
      * Funciones de manejo de arreglos
    */
    function zeros(longitud){
      let arr=[];

      for( i= 0 ; i<longitud ; i++){
        arr.push(0)
      }
      
      return arr
    }
    //https://stackoverflow.com/questions/20477177/creating-an-array-of-cumulative-sum-in-javascript/45658551
    function cumsum(vector){
      const cumulativeSum = (sum => value => sum += value)(0);
      return vector.map(cumulativeSum);
    }
    function divide_vect(vector,divisor){
      return vector.map(valor=> valor/divisor)
    }
    function suma_vect(vector){
      let suma=0
      vector.forEach(valor=>suma+=valor)
      return suma
    }
      /*
  * Funaciones auxiliares
*/
String.prototype.replaceAt = function(index, replacement) {
    return this.substr(0, index) + replacement + this.substr(index + replacement.length);
}
  /*
   * Funciones  para el manejo de bigints //https://stackoverflow.com/questions/39334494/converting-large-numbers-from-binary-to-decimal-and-back-in-javascript
  */
    function parseBigInt(bigint, base) {
  //convert bigint string to array of digit values
  for (var values = [], i = 0; i < bigint.length; i++) {
    values[i] = parseInt(bigint.charAt(i), base);
  }
  return values;
}

function formatBigInt(values, base) {
  //convert array of digit values to bigint string
  for (var bigint = '', i = 0; i < values.length; i++) {
    bigint += values[i].toString(base);
  }
  return bigint;
}

function convertBase(bigint, inputBase, outputBase) {
  //takes a bigint string and converts to different base
  var inputValues = parseBigInt(bigint, inputBase),
    outputValues = [], //output array, little-endian/lsd order
    remainder,
    len = inputValues.length,
    pos = 0,
    i;
  while (pos < len) { //while digits left in input array
    remainder = 0; //set remainder to 0
    for (i = pos; i < len; i++) {
      //long integer division of input values divided by output base
      //remainder is added to output array
      remainder = inputValues[i] + remainder * inputBase;
      inputValues[i] = Math.floor(remainder / outputBase);
      remainder -= inputValues[i] * outputBase;
      if (inputValues[i] == 0 && i == pos) {
        pos++;
      }
    }
    outputValues.push(remainder);
  }
  outputValues.reverse(); //transform to big-endian/msd order
  return formatBigInt(outputValues, outputBase);
}
function concat_zeros(no_bin,n_bits){
      while(no_bin.length<n_bits){
        no_bin="0"+no_bin
      }
      return no_bin
    }
    var precision=0
    var n_bits
    var n_alimentos
    var n_individuos=30
    var n_iteraciones=200
    var n_bits_alimento
    /**
     * @param tabla 
     tabla[0]=Cereales y tuberculos
     tabla[1]=Verduras
     tabla[2]=Frutas
     tabla[3]=Alimento de origen animal
     tabla[4]=Leche y sustitutos
     tabla[5]=Leguminosas
     tabla[6]=Grasas
     tabla[7]=Azucares
     tabla[8]=Alimento libres de energia
    */
   function algoritmo_genetico_tablas(tablas,objetivo){
     //Objetivo sin contar los alimentos estaticos (frutas,verduras,etc)
     let nuevo_objetivo=get_nuevo_objetivo(tablas,objetivo)
     console.log(nuevo_objetivo);
    // nbits y n _bits_alimento son arreglos donde cada posicion representa una comida[Desayuno,Colacion,Comida,Colacion,Cena]
    [n_bits,n_bits_alimento]=get_n_bits_tablas(tablas)
    console.log("n_bit_alimentos")
    console.log(n_bits_alimento)
    let poblacion = gen_poblacion_inicial_tablas(tablas)
    for (let i=0 ; i<n_iteraciones;i++){
      poblacion = gen_nueva_poblacion(poblacion,nuevo_objetivo,tablas)
      // console.log("res:"+get_z(poblacion[0],nuevo_objetivo))
    }
    return poblador_to_res(poblacion[0])
    function poblador_to_res(poblador){
      let res=[]
      let estaticos={"0":1,"1":2,"4":5,"13":8}
      let arr_id_alimento={"alimentosOrigenAnimal":[5,6,7,8],
    "cerealesYTuberculos":[2,3],"leche":[9,10],"grasas":[14,15,16],"azucares":[11,12]}
      poblador.forEach((comida,selector_comida) =>{
        let aux=[]
        for(const indice in estaticos){
          aux[parseInt(indice,0)]=tablas[selector_comida][estaticos[indice]]
        }
        let alimentos = get_alimentos(comida,n_bits_alimento[selector_comida],n_bits[selector_comida])
        for(const alimento in alimentos){
          alimentos[alimento].forEach((n,index)=>{
            aux[arr_id_alimento[alimento][index]]=n
          })
          
        }
        res[selector_comida]=aux
      })
      return res 
    }
    function  gen_nueva_poblacion(poblacion,objetivo,tablas){
      let resultados=[]
      let resultado2
      for( let poblador of poblacion){
        resultados.push(get_z(poblador,objetivo))
      }
      resultados2=resultados.map(z =>{
        return 1/(1+z)
      })
      // Suma de todos los resultados
      let suma=suma_vect(resultados2)
      // Obtencion de vector con porcentajes acumulados
      let acum=cumsum(divide_vect(resultados2,suma))
      let vect_padres=zeros(poblacion.length)
      //Seleccion aleatoria de los mejores vectores
      for (let poblador of poblacion)
        vect_padres[bisect(acum, Math.random())] += 1
      // juntamos el vector de los padres seleccionados y la poblacion
      let arr_padres_poblacion = vect_padres.map((valor,index)=>{
        return [valor,poblacion[index]]
      })
      //ordenamos ese vector
      arr_padres_poblacion.sort((a,b)=>{
        return b[0]-a[0]
      })
      //regresamos a su forma original los vectores
      vect_padres =arr_padres_poblacion.map((valor,index)=>{
        poblacion[index]=valor[1]
        return valor[0]
      })
      // numero de vectores diferentes de zero
      let vectores_dif_zero=0
      for (vector of vect_padres){
        if(vector !== 0){
          vectores_dif_zero+=1
        }
      }
      //calculo de hijos a generar
    let num_hijos=n_individuos-vectores_dif_zero
    let n_total=0
    n_bits.forEach(n=>{
      n_total+=n
    })
   //generacion de los hijos
    for (let i=0; i< num_hijos;i++){
        if (vectores_dif_zero >= 2){
            let aleat=Math.floor(Math.random()*(2*n_total))
            if(aleat-n_total >= 0){
                poblacion[vectores_dif_zero+i] = cruce(poblacion[0],poblacion[1],aleat-n_total,tablas)
              }
            else{
                poblacion[vectores_dif_zero+i] = mutacion(poblacion[0],aleat,tablas)
              }
        }
        else{
            aleat=Math.floor(Math.random()*(n_total))
            poblacion[vectores_dif_zero+i] = mutacion(poblacion[0],aleat,tablas)
          }
    }
      return poblacion
    }
    function cruce(poblador1,poblador2,aleat,tablas){
     
      let aux=aleat
      let selector_comida
      n_bits.some((n,index)=>{
        aux-=n
        if(aux<0){
          selector_comida=index
          return true
        }
        return false
      })
      let posicion = n_bits[selector_comida]+aux
      let poblador_res=[]
      for(let i= 0 ; i< selector_comida ; i++){
        poblador_res.push(poblador1[i])
      }
      let numeroA_bin=concat_zeros(convertBase(poblador1[selector_comida],10,2),n_bits[selector_comida])
      let numeroB_bin=concat_zeros(convertBase(poblador2[selector_comida],10,2),n_bits[selector_comida])
      aux=[]
      for(i=n_bits[selector_comida]-1; i> posicion;i--){
        aux[i]=numeroB_bin[numeroB_bin.length-1+(i-(n_bits[selector_comida]-1))]
      }
      for(i=posicion;i>=0;i--){
        let posicionA=numeroA_bin.length-1+(i-(n_bits[selector_comida]-1))
        if(posicionA >=0 )
          aux[i]=numeroA_bin[posicionA]
        else
          break
      }
      let comida_bin=aux.join("")
      comida_bin=cumplir_tablas(comida_bin,
      n_bits_alimento[selector_comida],tablas[selector_comida],posicion,
      n_bits[selector_comida])
      poblador_res.push(convertBase(comida_bin,2,10))
      if(!cumpleTablas(poblador_res[poblador_res.length-1],
      tablas[selector_comida],n_bits_alimento[selector_comida],n_bits[selector_comida])){
        console.error("No cumplio (cruce)")
      }
      for(let i=selector_comida+1; i<poblador2.length ;i++){
        poblador_res.push(poblador2[i])
      }
      return poblador_res
      /*
     let numeroB_bin=convertBase(numeroB,10,2)
      let numeroA_bin=convertBase(numeroA,10,2)
      aux=[]
      for(i=n_bits-1; i> posicion;i--){
        aux[i]=numeroB_bin[numeroB_bin.length-1+(i-n_bits-1)]
      }
      for(i=posicion;i>0;i--){
        let posicionA=numeroA_bin.length-1+(i-n_bits-1)
        if(posicionA >=0 )
          aux[i]=numeroA_bin[posicionA]
        else
          break
      }
      return convertBase(aux.join(""),2,10)
      */

    }
    function mutacion(poblador,aleat,tablas){
      aux=aleat
      let selector_comida
      n_bits.some((n,index)=>{
        aux-=n
        if(aux<0){
          selector_comida=index
          return true
        }
        return false
      })
      let posicion=n_bits[selector_comida]+aux
      let comida_poblador_bin=convertBase(poblador[selector_comida],10,2)
      comida_poblador_bin=concat_zeros(comida_poblador_bin,n_bits[selector_comida])
      if(comida_poblador_bin[posicion] === '1'){
        comida_poblador_bin=comida_poblador_bin.replaceAt(posicion,'0')  
      }
      else{
        comida_poblador_bin=comida_poblador_bin.replaceAt(posicion,'1')
      }
      comida_poblador_bin=cumplir_tablas(comida_poblador_bin,
      n_bits_alimento[selector_comida],tablas[selector_comida],posicion,n_bits[selector_comida])
      poblador[selector_comida]=convertBase(comida_poblador_bin,2,10)
      if(!cumpleTablas(convertBase(comida_poblador_bin,2,10),
      tablas[selector_comida],n_bits_alimento[selector_comida],n_bits[selector_comida])){
        console.error("No cumple(Mutacion)")
      }
      return poblador
    }
    function cumplir_tablas(bin,n_bits_alimento,tabla,bit_modificado,n_bits){
      let categoria
      let posicion_categoria;
      let alimentos;
      [categoria,posicion_categoria]=get_categoria(n_bits_alimento,bit_modificado)
      alimentos=get_alimentos(convertBase(bin,2,10),n_bits_alimento,n_bits)
      let restante = tabla[n_bits_alimento[categoria][2]]-alimentos[categoria][posicion_categoria]
      while(restante < 0){
        alimentos[categoria][posicion_categoria]-=1
        restante = tabla[n_bits_alimento[categoria][2]]-alimentos[categoria][posicion_categoria]
      }
      
      alimentos[categoria].forEach((n,index)=>{
        if(index !== posicion_categoria){
          if(restante !== 0){
            if ((posicion_categoria === alimentos[categoria].length-1) && 
            (index === alimentos[categoria].length-2)){
              alimentos[categoria][index]=restante
              restante =0
            }
            else if(index === alimentos[categoria].length-1){
              alimentos[categoria][index]=restante
              restante =0
            }
            else{
              if(restante >= n ){
                restante-=n
              }
              else{
                alimentos[categoria][index]=Math.floor(Math.random()*restante)
                restante-=alimentos[categoria][index]
              }
            }
          }
          else{
            alimentos[categoria][index]=0
          }
        }
      })
      
      let auxi=get_alimentos(convertBase(
        alimento_to_bin(alimentos,n_bits_alimento,n_bits),2,10),n_bits_alimento,n_bits)
      return alimento_to_bin(alimentos,n_bits_alimento,n_bits)
    }
    function alimento_to_bin(alimentos,n_bits_alimento,n_bits){
      aux=""
      for(const alimento in alimentos){
        alimentos[alimento].forEach((n,index)=>{
          if(n_bits_alimento[alimento][0] !== 0)
            aux+=concat_zeros(n.toString(2),
            (n_bits_alimento[alimento][0]/n_bits_alimento[alimento][1]))
        })
      }
      return aux
    }
    function get_categoria(n_bits,bit_modificado){
      let aux=bit_modificado
      for(const alimento in n_bits){
        aux-=n_bits[alimento][0]
        if(aux <0 ){
          return [alimento,Math.floor((n_bits[alimento][0]+aux)/
          //bits por alimento
          (n_bits[alimento][0]/n_bits[alimento][1]))]
        }
      }
    }
    function get_z(poblador,objetivo){
      let acum_kcal=0
      //id de los alimentos en dict_alimentos
      let arr_id_alimento={"alimentosOrigenAnimal":[5,6,7,8],
    "cerealesYTuberculos":[2,3],"leche":[9,10],"grasas":[14,15,16],"azucares":[11,12]}
      let n_alimentos
      poblador.forEach((comida_poblador,index) => {
        n_alimentos=get_alimentos(comida_poblador,n_bits_alimento[index],n_bits[index])
        for( const alimento in n_alimentos){
          n_alimentos[alimento].forEach((n,index)=>{
            acum_kcal+=n*dict_alimentos[arr_id_alimento[alimento][index]][0]
          })
        }
      })
      return Math.abs(objetivo-acum_kcal)
    }
    function get_alimentos(comida_poblador,n_bits_alimento,n_bits){
      let arr_alimentos={}
      let comida_bin=convertBase(comida_poblador,10,2)
      while (n_bits >comida_bin.length )
        comida_bin="0"+comida_bin
      //auxiliar para ir recorriendo la cadena de bits
      let aux=0
      let salto
      for (const alimento in n_bits_alimento){
        arr_alimentos[alimento]=[]
        salto=n_bits_alimento[alimento][0]/n_bits_alimento[alimento][1] 
        for(let i=1;i<=n_bits_alimento[alimento][1];i++){
          if(salto==0){
            arr_alimentos[alimento].push(0)
          }
          else{
            arr_alimentos[alimento].push(parseInt(convertBase(comida_bin.substring(aux+salto*(i-1),aux+salto*(i)),2,10),10))
          }
        }
        aux+=salto*n_bits_alimento[alimento][1]
      }
      return arr_alimentos
   
      /*
      let alimentos=[]
      let valor_bin=convertBase(valor,10,2)
      let bits_por_alimento=n_bits/n_alimentos
      let bits_sobrantes=n_bits-valor_bin.length
      for(let i=0;i<bits_sobrantes;i++){
        valor_bin="0"+valor_bin
      }
      for(let i=bits_por_alimento;i<(n_bits+bits_por_alimento);i+=bits_por_alimento){
        alimentos.push(Math.round(
          parseInt(
            convertBase(valor_bin.substring(i-bits_por_alimento,i),2,10))/
        Math.pow(10,precision)))
      }
      return alimentos
      */
    }
    function get_nuevo_objetivo(tablas,objetivo){
      let kcal_acum=0
      // id de los alimentos en tablas
      let alimentos_estaticos=[1,2,5,8]
      //id de los alimentos en dict_alimentos
      let dict_alimetos_estaticos=[0,1,4,13]
      tablas.forEach(tabla=>{
        alimentos_estaticos.forEach((idAlimento,index) =>{
          kcal_acum+=tabla[idAlimento]*dict_alimentos[dict_alimetos_estaticos[index]][0]
        })
      })
      return objetivo-kcal_acum
     

    }
    function gen_poblacion_inicial_tablas(tablas){
      let poblacion = []
      let poblador
      for(let i=0;i<n_individuos;i++){
        poblador=getPoblador(tablas)
        poblacion.push(poblador)
      }
      return poblacion
    }
    function get_random_int_tablas(tabla,n_bits_alimento){
      //aux_bin es la variable donde de guardara el entero generado en forma binaria
      let aux_bin=""
      for( const alimento in n_bits_alimento){
        let indice_tabla = n_bits_alimento[alimento][2]
        let no_subgrupos = n_bits_alimento[alimento][1]
        let n_bits_tipo_alimento = n_bits_alimento[alimento][0]
        let n_bits_subgrupo_alimento =n_bits_tipo_alimento/no_subgrupos
        let no_aleatorio
        let restante=tabla[indice_tabla]
        if(n_bits_subgrupo_alimento != 0){
        for(let i=0 ; i< no_subgrupos;i++){
          if(restante == 0){
            aux_bin+=concat_zeros("0",n_bits_subgrupo_alimento)
          }
          else if(i== no_subgrupos-1){
            aux_bin+=concat_zeros(restante.toString(2),n_bits_subgrupo_alimento)
            restante=0
            
          }
          else{
            no_aleatorio=Math.floor(Math.random()*(restante+1))
            aux_bin+=concat_zeros(no_aleatorio.toString(2),n_bits_subgrupo_alimento)
            restante=restante-no_aleatorio
            
          }
        }
      }
      }
      return convertBase(aux_bin,2,10)
    }
    function getPoblador(tablas){
      let poblador = []
      //poblador es un arreglo de comida_poblador
      let comida_poblador
      tablas.forEach((tabla,index) =>{
        comida_poblador=get_random_int_tablas(tabla,n_bits_alimento[index])
        while(!cumpleTablas(comida_poblador,tabla,n_bits_alimento[index],n_bits[index])){
          console.error("No cumplio")
          comida_poblador=get_random_int_tablas(tabla,n_bits_alimento[index])
        }
        poblador.push(comida_poblador)
      })
      return poblador

    }
    function cumpleTablas(comida_poblador,tabla,n_bits_alimento,n_bits){
      let alimentos = get_alimentos(comida_poblador,n_bits_alimento,n_bits)
      let n_alimentos
      for (const alimento in alimentos){
        n_alimentos=0
        alimentos[alimento].forEach(n => {
          n_alimentos+=n
        })
        if(n_alimentos != tabla[n_bits_alimento[alimento][2]]){
          console.log(alimento)
          console.log(n_alimentos)
          console.log("isdif")
          console.log(tabla[n_bits_alimento[alimento][2]])
          return false
        }
      }
      return true
      //auxiliar para ir recorriendo la cadena de bits
      /*
      let n_alimentos
      for (const alimento in n_bits_alimento){
        n_alimentos=BigInt(0);
        salto=n_bits_alimento[alimento][0]/n_bits_alimento[alimento][1] 
        for(let i=1;i<=n_bits_alimento[alimento][1];i++){
          n_alimentos+=BigInt(convertBase(comida_bin.substring(aux+salto*(i-1),aux+salto*(i)),2,10))
        }
        if(n_alimentos != tabla[n_bits_alimento[alimento][2]]){
          return false
        }
        aux+=salto*n_bits_alimento[alimento][1]
      }*/
    }
  function get_n_bits_tablas(tablas){
    let arr_n_bits=[]
    let arr_n_bits_alimento=[]
    tablas.forEach(tabla =>{
      let n_bits=0
      let n_bits_alimento={}
      // bits de cereales y tuberculos;2=[Con Grasa , Sin grasa]
      n_bits_alimento["cerealesYTuberculos"]=[2*Math.ceil(Math.log2((tabla[0]+1)*Math.pow(10,precision))),2,0]
      n_bits+=n_bits_alimento["cerealesYTuberculos"][0]
      // bits de alimentos de origen animal;4=[¨Muy bajo aporte de grasa,Bajo aporte de grasa,
      // Moderado aportr de grasa]
      n_bits_alimento["alimentosOrigenAnimal"]=[4*Math.ceil(Math.log2((tabla[3]+1)*Math.pow(10,precision))),4,3]
      n_bits+= n_bits_alimento["alimentosOrigenAnimal"][0]
      // bits de leche y sustitutos ; 2=[Descremada,entera]
      n_bits_alimento["leche"]=[2*Math.ceil(Math.log2((tabla[4]+1)*Math.pow(10,precision))),2,4]
      n_bits+=n_bits_alimento["leche"][0]
      //bits de grasas ;3 =[fuente de monoinssaturadas,fuente de poliinsaturadas,
                        //funte de saturadas y trans]
      n_bits_alimento["grasas"]=[3*Math.ceil(Math.log2((tabla[6]+1)*Math.pow(10,precision))),3,6]
      n_bits+=n_bits_alimento["grasas"][0]
      //bits de azucares ; 2=[sin grasa,con grasa]
      n_bits_alimento["azucares"]=[2*Math.ceil(Math.log2((tabla[7]+1)*Math.pow(10,precision))),2,7]
      n_bits+=n_bits_alimento["azucares"][0]
      arr_n_bits.push( n_bits)
      arr_n_bits_alimento.push(n_bits_alimento)
    })
    return [arr_n_bits,arr_n_bits_alimento]
   }
   }
 
   function algoritmo_genetico(kcal){
    let max_raciones_por_alimento=3
    n_alimentos=dict_alimentos.length
    n_bits=get_n_bits(max_raciones_por_alimento)
    let poblacion = gen_poblacion_inicial(n_individuos)
    for (let i=0 ; i<n_iteraciones;i++){
      poblacion = gen_nueva_poblacion(poblacion,kcal)
    }
    return get_alimentos(poblacion[0])

    function cruce(numeroA,numeroB,posicion){
      let numeroB_bin=concat_zeros(convertBase(numeroB,10,2),n_bits-1)
      let numeroA_bin=concat_zeros(convertBase(numeroA,10,2),n_bits-1)
      let aux=[]
      for(i=n_bits-1; i> posicion;i--){
        aux[i]=numeroB_bin[numeroB_bin.length-1+(i-(n_bits-1))]
      }
      for(i=posicion;i>=0;i--){
        let posicionA=numeroA_bin.length-1+(i-(n_bits-1))
        if(posicionA >=0 )
          aux[i]=numeroA_bin[posicionA]
        else
          break
      }
      return convertBase(aux.join(""),2,10)
    }
    function mutacion(numero,posicion){
      let aux=convertBase(numero,10,2)
      while(posicion+1 > aux.length )
        aux="0"+aux
      if(aux[posicion] === '1'){
        aux=aux.replaceAt(posicion,'0')  
      }
      else{
        aux=aux.replaceAt(posicion,'1')
      }
      return convertBase(aux,2,10)
    }
    function gen_nueva_poblacion(poblacion,objetivo){
      let resultados=[]
      let resultados2
      for( let poblador of poblacion){
        resultados.push(get_z(poblador,objetivo))
      }
      resultados2=resultados.map(z =>{
        return 1/(1+z)
      })
      // Suma de todos los resultados
      let suma=suma_vect(resultados2)
      // Obtencion de vector con porcentajes acumulados
      let acum=cumsum(divide_vect(resultados2,suma))
      let vect_padres=zeros(poblacion.length)
      //Seleccion aleatoria de los mejores vectores
      for (let poblador of poblacion)
        vect_padres[bisect(acum, Math.random())] += 1
      // juntamos el vector de los padres seleccionados y la poblacion
      let arr_padres_poblacion = vect_padres.map((valor,index)=>{
        return [valor,poblacion[index]]
      })
      //ordenamos ese vector
      arr_padres_poblacion.sort((a,b)=>{
        return b[0]-a[0]
      })
      //regresamos a su forma original los vectores
      vect_padres =arr_padres_poblacion.map((valor,index)=>{
        poblacion[index]=valor[1]
        return valor[0]
      })
      // numero de vectores diferentes de zero
      let vectores_dif_zero=0
      for (vector of vect_padres){
        if(vector !== 0){
          vectores_dif_zero+=1
        }
      }
      //calculo de hijos a generar
    let num_hijos=n_individuos-vectores_dif_zero
   //generacion de los hijos
    for (let i=0; i< num_hijos;i++){
        if (vectores_dif_zero >= 2){
            let aleat=Math.floor(Math.random()*(2*n_bits))
            if(aleat-n_bits >= 0){
                poblacion[vectores_dif_zero+i] = cruce(poblacion[0],poblacion[1],aleat-n_bits)
              }
            else{
                poblacion[vectores_dif_zero+i] = mutacion(poblacion[0],aleat)
              }
        }
        else{
            aleat=Math.floor(Math.random()*n_bits)
            poblacion[vectores_dif_zero+i] = mutacion(poblacion[0],aleat)
          }
    }
      return poblacion

    }
    

    /*
     * Funciones correspondientes al algoritmo
    */
    function get_z(poblador,objetivo){
      let alimentos=get_alimentos(poblador)
      let z=0
      for (let i=0 ; i<alimentos.length ; i++){
        z+=alimentos[i]*dict_alimentos[i][0]
      }
      return Math.abs(z-objetivo)
    }
    function get_energia(poblador){
      let alimentos=get_alimentos(poblador)
      let z=0
      for (let i=0 ; i<alimentos.length ; i++){
        z+=alimentos[i]*dict_alimentos[i][0]
      }
      return z
    }
    function get_alimentos(valor){
      let alimentos=[]
      let valor_bin=convertBase(valor,10,2)
      let bits_por_alimento=n_bits/n_alimentos
      let bits_sobrantes=n_bits-valor_bin.length
      for(let i=0;i<bits_sobrantes;i++){
        valor_bin="0"+valor_bin
      }
      for(let i=bits_por_alimento;i<(n_bits+bits_por_alimento);i+=bits_por_alimento){
        alimentos.push(Math.round(
          parseInt(
            convertBase(valor_bin.substring(i-bits_por_alimento,i),2,10))/
        Math.pow(10,precision)))
      }
      return alimentos
    }
    function get_n_bits(raciones){
       let n_bits 
       //n_bits=n_alimentos*bits para cada alimento
       n_bits=n_alimentos*Math.ceil(Math.log2((raciones+1)*Math.pow(10,precision)));  
       return n_bits
      }
    function gen_poblacion_inicial(n_individuos){
      let poblacion = []
      for(let i=0;i<n_individuos;i++){
        poblador=get_random_int()
        poblacion.push(poblador)
      }
      return poblacion
    }
    function get_random_int(){
      let n_iteraciones = Math.floor(n_bits/35) //2**35 es aproximadamente el numero maximo aleatorio
      let  residuo = n_bits%35
      let max_aleatorio=Math.pow(2,35)
      let aux=""//cadena auxiliar donde se iran guardando los resultados
      for (let i = 0;i<n_iteraciones;i++){
        aux+=(Math.floor(Math.random()*(max_aleatorio))).toString(2)
      }
      aux+=(Math.floor(Math.random()*(Math.pow(2,residuo)))).toString(2)
      return convertBase(aux,2,10)
    }

   }

</script>


{% endblock %}

